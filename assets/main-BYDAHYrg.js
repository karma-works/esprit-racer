(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function s(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(o){if(o.ep)return;o.ep=!0;const i=s(o);fetch(o.href,i)}})();const k={LEFT:37,UP:38,RIGHT:39,DOWN:40,A:65,D:68,S:83,W:87,P:80,F:70,SPACE:32},de={FOG:"#005108",LIGHT:{road:"#6B6B6B",grass:"#10AA10",rumble:"#555555",lane:"#CCCCCC"},DARK:{road:"#696969",grass:"#009A00",rumble:"#BBBBBB"},START:{road:"white",grass:"white",rumble:"white"},CHECKPOINT:{road:"#FFFF88",grass:"#FFFF88",rumble:"#FFFF88"},FINISH:{road:"black",grass:"black",rumble:"black"}},b={CHECKPOINT_BANNER:{x:5,y:5,w:400,h:120},FINISH_BANNER:{x:410,y:5,w:400,h:120},PALM_TREE:{x:5,y:5,w:215,h:540},BILLBOARD08:{x:230,y:5,w:385,h:265},TREE1:{x:625,y:5,w:360,h:360},DEAD_TREE1:{x:5,y:555,w:135,h:332},BILLBOARD09:{x:150,y:555,w:328,h:282},BOULDER3:{x:230,y:280,w:320,h:220},COLUMN:{x:995,y:5,w:200,h:315},BILLBOARD01:{x:625,y:375,w:300,h:170},BILLBOARD06:{x:488,y:555,w:298,h:190},BILLBOARD05:{x:5,y:897,w:298,h:190},BILLBOARD07:{x:313,y:897,w:298,h:190},BOULDER2:{x:621,y:897,w:298,h:140},TREE2:{x:1205,y:5,w:282,h:295},BILLBOARD04:{x:1205,y:310,w:268,h:170},DEAD_TREE2:{x:1205,y:490,w:150,h:260},BOULDER1:{x:1205,y:760,w:168,h:248},BUSH1:{x:5,y:1097,w:240,h:155},CACTUS:{x:929,y:897,w:235,h:118},BUSH2:{x:255,y:1097,w:232,h:152},BILLBOARD03:{x:5,y:1262,w:230,h:220},BILLBOARD02:{x:245,y:1262,w:215,h:220},STUMP:{x:995,y:330,w:195,h:140},SEMI:{x:1365,y:490,w:122,h:144},TRUCK:{x:1365,y:644,w:100,h:78},CAR03:{x:1383,y:760,w:88,h:55},CAR02:{x:1383,y:825,w:80,h:59},CAR04:{x:1383,y:894,w:80,h:57},CAR01:{x:1205,y:1018,w:80,h:56},PLAYER_STRAIGHT:{w:80,h:41}},te=.3*(1/b.PLAYER_STRAIGHT.w),ye={BILLBOARDS:[b.BILLBOARD01,b.BILLBOARD02,b.BILLBOARD03,b.BILLBOARD04,b.BILLBOARD05,b.BILLBOARD06,b.BILLBOARD07,b.BILLBOARD08,b.BILLBOARD09],PLANTS:[b.TREE1,b.TREE2,b.DEAD_TREE1,b.DEAD_TREE2,b.PALM_TREE,b.BUSH1,b.BUSH2,b.CACTUS,b.STUMP,b.BOULDER1,b.BOULDER2,b.BOULDER3],CARS:[b.CAR01,b.CAR02,b.CAR03,b.CAR04,b.SEMI,b.TRUCK]},S={LENGTH:{SHORT:25,MEDIUM:50,LONG:100},HILL:{NONE:0,LOW:20,MEDIUM:40,HIGH:60},CURVE:{EASY:2,MEDIUM:4}},gt={night:{id:"night",name:"Night",description:"Moody and fast. Manhattan-style skyline with neon accents.",colors:{sky:"#0a0a1a",fog:"#001122",road:{road:"#1a1a2e",grass:"#0d1117",rumble:"#2d2d44",lane:"#ffdd00"}},effects:{fogDensity:4,fogStart:.6},physics:{grip:1,offRoadGrip:.8,maxSpeed:1,acceleration:1,brakeForce:1},filters:{global:"brightness(0.7) saturate(0.9)",background:"brightness(0.5)",road:""},background:"background-level-1.svg"},fog:{id:"fog",name:"Fog",description:"Tense and claustrophobic. Visibility severely reduced.",colors:{sky:"#9e9e9e",fog:"#7a8a7a",road:{road:"#5a5a5a",grass:"#4a5d4a",rumble:"#6a6a6a",lane:"#888888"}},effects:{fogDensity:8,fogStart:.3},physics:{grip:1,offRoadGrip:.9,maxSpeed:.95,acceleration:1,brakeForce:1},filters:{global:"blur(0.3px) contrast(0.9) brightness(0.9)",background:"",road:""},background:"background-level-1.svg"},snow:{id:"snow",name:"Snow",description:"Slippery and bright. Car skids on ice patches.",colors:{sky:"#e8f4fc",fog:"#d0e8f0",road:{road:"#e8e8e8",grass:"#f5f5f5",rumble:"#cccccc",lane:"#333333"}},effects:{fogDensity:3,fogStart:.7,snow:{density:50,speed:2,direction:.1,sprite:"snowflake.svg"}},physics:{grip:.6,offRoadGrip:.3,maxSpeed:.85,acceleration:.8,brakeForce:.5,slippery:!0},filters:{global:"saturate(0.7) brightness(1.05)",background:"",road:""},background:"background-level-1.svg"},storm:{id:"storm",name:"Storm",description:"Intense and chaotic. Lightning and heavy rain.",colors:{sky:"#2d1b4e",fog:"#1a1a2e",road:{road:"#4a4a5a",grass:"#2a3a2a",rumble:"#5a5a6a",lane:"#8a8a9a"}},effects:{fogDensity:6,fogStart:.5,rain:{density:100,speed:8,direction:.2,sprite:"raindrop.svg"},lightning:{interval:8e3,duration:150,flashIntensity:.4}},physics:{grip:.85,offRoadGrip:.6,maxSpeed:.9,acceleration:.95,brakeForce:.9,slippery:!0},filters:{global:"saturate(0.8) brightness(0.85) contrast(1.1)",background:"",road:""},background:"background-level-1.svg"},desert:{id:"desert",name:"Desert",description:"Hot and hazardous. Sand slows you down.",colors:{sky:"#f4a460",fog:"#daa520",road:{road:"#d2691e",grass:"#f4a460",rumble:"#8b4513",lane:"#ffdead"}},effects:{fogDensity:3,fogStart:.7,heatHaze:!0},physics:{grip:.95,offRoadGrip:.4,maxSpeed:1,acceleration:.9,brakeForce:1},filters:{global:"saturate(1.2) sepia(0.15) brightness(1.05)",background:"",road:""},background:"background-level-1.svg"},future:{id:"future",name:"Future",description:"Sci-fi vibe. Turbo zones and laser obstacles.",colors:{sky:"#0d0d2a",fog:"#1a1a3e",road:{road:"#1a1a3e",grass:"#0d0d2a",rumble:"#00ffff",lane:"#ff00ff"}},effects:{fogDensity:2,fogStart:.8},physics:{grip:1,offRoadGrip:.8,maxSpeed:1.2,acceleration:1.1,brakeForce:1,turboZones:!0},filters:{global:"contrast(1.2) saturate(1.2) hue-rotate(10deg)",background:"",road:""},background:"background-level-1.svg"},marsh:{id:"marsh",name:"Marsh",description:"Slippery and dirty. Oil and water make handling difficult.",colors:{sky:"#4a5d4a",fog:"#3d4d3d",road:{road:"#5d4037",grass:"#2e7d32",rumble:"#4a3a2a",lane:"#8a8a7a"}},effects:{fogDensity:4,fogStart:.6},physics:{grip:.7,offRoadGrip:.3,maxSpeed:.85,acceleration:.7,brakeForce:.8,slippery:!0},filters:{global:"saturate(0.8) brightness(0.9)",background:"",road:""},background:"background-level-1.svg"},mountains:{id:"mountains",name:"Mountains",description:"Precarious. Narrow roads with sheer drops.",colors:{sky:"#87ceeb",fog:"#a0a0a0",road:{road:"#6b4423",grass:"#4a7c4a",rumble:"#808080",lane:"#cccccc"}},effects:{fogDensity:4,fogStart:.5},physics:{grip:1,offRoadGrip:.5,maxSpeed:.9,acceleration:.95,brakeForce:1.1},filters:{global:"saturate(0.9) brightness(0.95)",background:"",road:""},background:"background-level-1.svg"},lakes:{id:"lakes",name:"Lakes",description:"Scenic but tricky. Jump across rivers.",colors:{sky:"#87ceeb",fog:"#a0d0e0",road:{road:"#4a4a4a",grass:"#4caf50",rumble:"#3a8a3a",lane:"#ffffff"}},effects:{fogDensity:2,fogStart:.8},physics:{grip:.9,offRoadGrip:.6,maxSpeed:1,acceleration:1,brakeForce:.9,jumpZones:!0},filters:{global:"saturate(1.2) brightness(1.05)",background:"",road:""},background:"background-level-1.svg"},country:{id:"country",name:"Country",description:"Relaxed but winding. Logs, rocks, and fords.",colors:{sky:"#87ceeb",fog:"#a0c0a0",road:{road:"#5a5a5a",grass:"#4caf50",rumble:"#8b4513",lane:"#ffffff"}},effects:{fogDensity:2,fogStart:.8},physics:{grip:1,offRoadGrip:.7,maxSpeed:1,acceleration:1,brakeForce:1},filters:{global:"saturate(1.2) brightness(1.1)",background:"",road:""},background:"background-level-1.svg"},city:{id:"city",name:"City",description:"Urban and busy. Wide motorway with oncoming traffic.",colors:{sky:"#4a6080",fog:"#3a4a5a",road:{road:"#4a4a4a",grass:"#2a2a2a",rumble:"#1a1a1a",lane:"#ffffff"}},effects:{fogDensity:3,fogStart:.7},physics:{grip:1,offRoadGrip:.3,maxSpeed:1.1,acceleration:1,brakeForce:1},filters:{global:"saturate(0.9) brightness(0.95)",background:"",road:""},background:"background-level-1.svg"},roadworks:{id:"roadworks",name:"Roadworks",description:"Frantic. Bollards and signs everywhere.",colors:{sky:"#708090",fog:"#5a6a7a",road:{road:"#4a4a4a",grass:"#3a3a3a",rumble:"#ff6600",lane:"#ffffff"}},effects:{fogDensity:3,fogStart:.7},physics:{grip:1,offRoadGrip:.5,maxSpeed:.85,acceleration:.9,brakeForce:1.2},filters:{global:"",background:"",road:""},background:"background-level-1.svg"},windy:{id:"windy",name:"Windy",description:"Open and quirky. Tumbleweeds and strong gusts.",colors:{sky:"#fffacd",fog:"#e8d8b8",road:{road:"#c4a06a",grass:"#d2b48c",rumble:"#8b7355",lane:"#ffffff"}},effects:{fogDensity:2,fogStart:.8,wind:{baseForce:.1,gustInterval:8e3,gustDuration:1500,maxGustForce:.2,direction:0}},physics:{grip:.95,offRoadGrip:.7,maxSpeed:1,acceleration:1,brakeForce:1,windForce:.3},filters:{global:"sepia(0.1) saturate(0.9)",background:"",road:""},background:"background-level-1.svg",spriteOverrides:{PALM_TREE:"CACTUS",TREE1:"DEAD_TREE1",TREE2:"DEAD_TREE2"}}},Bt=()=>new Date().getTime(),ds=(e,t)=>{if(e!=null){const s=parseInt(String(e),10);if(!isNaN(s))return s}return t},Qe=(e,t,s)=>Math.max(t,Math.min(e,s)),Le=(e,t)=>Math.round(Y(e,t,Math.random())),fe=e=>e[Le(0,e.length-1)],Re=(e,t)=>e%t/t,Pe=(e,t,s)=>e+t*s,Y=(e,t,s)=>e+(t-e)*s,hs=(e,t,s)=>e+(t-e)*Math.pow(s,2),Be=(e,t,s)=>e+(t-e)*(-Math.cos(s*Math.PI)/2+.5),Nt=(e,t)=>1/Math.pow(Math.E,e*e*t),le=(e,t,s)=>{let n=e+t;for(;n>=s;)n-=s;for(;n<0;)n+=s;return n},Fe=(e,t,s,n,o,i,r,a)=>{e.camera.x=(e.world.x??0)-t,e.camera.y=(e.world.y??0)-s,e.camera.z=(e.world.z??0)-n,e.screen.scale=o/e.camera.z,e.screen.x=Math.round(i/2+e.screen.scale*e.camera.x*i/2),e.screen.y=Math.round(r/2-e.screen.scale*e.camera.y*r/2),e.screen.w=Math.round(e.screen.scale*a*i/2)},we=(e,t,s,n,o=1)=>{const i=o/2,r=e-t*i,a=e+t*i,c=s-n*i,l=s+n*i;return!(a<c||r>l)};let O=[];const gs=()=>O,se=(e,t)=>{const s=Math.floor(e/t)%O.length;return O[s]},nt=()=>O.length===0?0:O[O.length-1].p2.world.y,Ze=(e,t,s,n)=>{const o=O.length;O.push({index:o,p1:{world:{x:0,y:nt(),z:o*s},camera:{x:0,y:0,z:0},screen:{x:0,y:0,scale:0,w:0}},p2:{world:{x:0,y:t,z:(o+1)*s},camera:{x:0,y:0,z:0},screen:{x:0,y:0,scale:0,w:0}},curve:e,sprites:[],cars:[],color:Math.floor(o/n)%2?de.DARK:de.LIGHT})},D=(e,t,s)=>{O[e]&&O[e].sprites.push({source:t,offset:s})},P=(e,t,s,n,o,i,r)=>{const a=nt(),c=a+ds(o,0)*i,l=e+t+s;for(let d=0;d<e;d++)Ze(hs(0,n,d/e),Be(a,c,d/l),i,r);for(let d=0;d<t;d++)Ze(n,Be(a,c,(e+d)/l),i,r);for(let d=0;d<s;d++)Ze(Be(n,0,d/s),Be(a,c,(e+t+d)/l),i,r)},ut=(e,t,s)=>{const n=e||S.LENGTH.MEDIUM;P(n,n,n,0,0,t,s)},us=(e,t,s,n)=>{const o=e;P(o,o,o,0,t,s,n)},je=(e,t,s,n,o)=>{const i=e||S.LENGTH.MEDIUM,r=t||S.CURVE.MEDIUM,a=s||S.HILL.NONE;P(i,i,i,r,a,n,o)},ps=(e,t)=>{P(S.LENGTH.SHORT,S.LENGTH.SHORT,S.LENGTH.SHORT,0,S.HILL.LOW/2,e,t),P(S.LENGTH.SHORT,S.LENGTH.SHORT,S.LENGTH.SHORT,0,-20,e,t),P(S.LENGTH.SHORT,S.LENGTH.SHORT,S.LENGTH.SHORT,S.CURVE.EASY,S.HILL.LOW,e,t),P(S.LENGTH.SHORT,S.LENGTH.SHORT,S.LENGTH.SHORT,0,0,e,t),P(S.LENGTH.SHORT,S.LENGTH.SHORT,S.LENGTH.SHORT,-2,S.HILL.LOW/2,e,t),P(S.LENGTH.SHORT,S.LENGTH.SHORT,S.LENGTH.SHORT,0,0,e,t)},ms=(e,t)=>{P(S.LENGTH.MEDIUM,S.LENGTH.MEDIUM,S.LENGTH.MEDIUM,-2,S.HILL.NONE,e,t),P(S.LENGTH.MEDIUM,S.LENGTH.MEDIUM,S.LENGTH.MEDIUM,S.CURVE.MEDIUM,S.HILL.MEDIUM,e,t),P(S.LENGTH.MEDIUM,S.LENGTH.MEDIUM,S.LENGTH.MEDIUM,S.CURVE.EASY,-20,e,t),P(S.LENGTH.MEDIUM,S.LENGTH.MEDIUM,S.LENGTH.MEDIUM,-2,S.HILL.MEDIUM,e,t),P(S.LENGTH.MEDIUM,S.LENGTH.MEDIUM,S.LENGTH.MEDIUM,-4,-40,e,t)},Ss=(e,t)=>{P(10,10,10,0,5,e,t),P(10,10,10,0,-2,e,t),P(10,10,10,0,-5,e,t),P(10,10,10,0,8,e,t),P(10,10,10,0,5,e,t),P(10,10,10,0,-7,e,t),P(10,10,10,0,5,e,t),P(10,10,10,0,-2,e,t)},Ts=(e,t)=>{P(200,200,200,-2,-nt()/e,e,t)},ys=()=>{D(20,b.BILLBOARD07,-1),D(40,b.BILLBOARD06,-1),D(60,b.BILLBOARD08,-1),D(80,b.BILLBOARD09,-1),D(100,b.BILLBOARD01,-1),D(120,b.BILLBOARD02,-1),D(140,b.BILLBOARD03,-1),D(160,b.BILLBOARD04,-1),D(180,b.BILLBOARD05,-1),D(240,b.BILLBOARD07,-1.2),D(240,b.BILLBOARD06,1.2),D(O.length-25,b.BILLBOARD07,-1.2),D(O.length-25,b.BILLBOARD06,1.2);for(let e=10;e<200;e+=4+Math.floor(e/100))D(e,b.PALM_TREE,.5+Math.random()*.5),D(e,b.PALM_TREE,1+Math.random()*2);for(let e=250;e<1e3;e+=5)D(e,b.COLUMN,1.1),D(e+Le(0,5),b.TREE1,-1-Math.random()*2),D(e+Le(0,5),b.TREE2,-1-Math.random()*2);for(let e=200;e<O.length;e+=3)D(e,fe(ye.PLANTS),fe([1,-1])*(2+Math.random()*5));for(let e=1e3;e<O.length-50;e+=100){const t=fe([1,-1]);D(e+Le(0,50),fe(ye.BILLBOARDS),-t);for(let s=0;s<20;s++){const n=fe(ye.PLANTS),o=t*(1.5+Math.random());D(e+Le(0,50),n,o)}}},pt=4,Rs=(e,t,s)=>{O=[],ut(S.LENGTH.SHORT,e,t),ps(e,t),ms(e,t),je(S.LENGTH.MEDIUM,S.CURVE.MEDIUM,S.HILL.LOW,e,t),Ss(e,t),je(S.LENGTH.LONG,S.CURVE.MEDIUM,S.HILL.MEDIUM,e,t),ut(S.LENGTH.MEDIUM,e,t),us(S.LENGTH.MEDIUM,S.HILL.HIGH,e,t),je(S.LENGTH.MEDIUM,-4,S.HILL.NONE,e,t),Ts(e,t),ys();const n=se(s,e);O[n.index+2].color=de.START,O[n.index+3].color=de.START;const o=O.length,i=Math.floor(o/(pt+1));for(let r=1;r<=pt;r++){const a=i*r;a<o-t&&(O[a].color=de.CHECKPOINT,D(a,b.CHECKPOINT_BANNER,0))}for(let r=0;r<t;r++)O[O.length-1-r].color=de.FINISH;return D(O.length-t-5,b.FINISH_BANNER,0),O.length*e},bs=(e,t)=>e*t,Es=()=>({fps:60,width:1024,height:768,lanes:3,roadWidth:2e3,segmentLength:200,rumbleLength:3,drawDistance:300,fogDensity:5,centrifugal:.3,maxSpeed:200/(1/60)*1.5,accel:200/(1/60)/5*1.5,braking:-12e3*1.5,decel:-2400*1.5,offRoadDecel:-6e3*1.5,offRoadLimit:200/(1/60)/4*1.5}),mt=e=>({x:0,z:e,position:0,speed:0}),Ms=(e,t)=>({...e,maxSpeed:e.maxSpeed*t.maxSpeed,accel:e.accel*t.acceleration,braking:e.braking*t.brakeForce,offRoadDecel:e.offRoadDecel*t.offRoadGrip,centrifugal:e.centrifugal*t.grip}),vs=(e,t)=>{e.currentTheme=t,e.config=Ms(e.baseConfig,t.physics),e.windState=Ht(),e.jumpState=_t(),e.particles=[],e.tumbleweeds=[],e.slideVelocity=0,e.lightningActive=!1,e.lightningTimer=0},St=(e,t,s)=>{const n=e.currentTheme;if(!n?.effects.wind)return;const o=e.windState,i=n.effects.wind;o.gustTimer+=t*1e3,!o.gusting&&o.gustTimer>i.gustInterval&&(Math.random()<.7&&(o.gusting=!0,o.gustDuration=i.gustDuration+Math.random()*1500,o.currentDirection=Math.random()>.5?1:-1,o.currentForce=i.baseForce+Math.random()*(i.maxGustForce-i.baseForce)),o.gustTimer=0),o.gusting&&o.gustTimer>o.gustDuration&&(o.gusting=!1,o.currentForce=0,o.currentDirection=0,o.gustTimer=0),o.gusting&&s>0&&(e.player.x+=o.currentForce*o.currentDirection*t*.5*s)},Tt=(e,t)=>{const s=e.jumpState;if(!s.active)return;const o=(performance.now()-s.startTime)/1e3/s.duration;o>=1?(s.active=!1,s.peakHeight=0,Ls(e,e.player.x)):s.peakHeight=4*s.peakHeight*(o-o*o)},Ls=(e,t)=>{for(let s=0;s<8;s++)e.particles.push({x:t,y:0,vx:(Math.random()-.5)*3,vy:-Math.random()*5,life:.5,sprite:"water-splash.svg",size:3+Math.random()*4})},yt=(e,t)=>{const s=e.currentTheme,n=e.windState.currentForce*e.windState.currentDirection;for(const o of e.particles)o.x+=(o.vx+n*50)*t,o.y+=o.vy*t,o.life-=t*.8;e.particles=e.particles.filter(o=>o.life>0&&o.y<e.config.height),s?.effects.snow&&Math.random()<s.effects.snow.density*t&&e.particles.push({x:Math.random()*e.config.width,y:-10,vx:s.effects.snow.direction*30,vy:s.effects.snow.speed*80,life:1,sprite:"snowflake.svg",size:2+Math.random()*3}),s?.effects.rain&&Math.random()<s.effects.rain.density*t&&e.particles.push({x:Math.random()*e.config.width,y:-10,vx:s.effects.rain.direction*50,vy:s.effects.rain.speed*200,life:.8,sprite:"raindrop.svg",size:1+Math.random()*2})},Rt=(e,t)=>{if(e.currentTheme?.effects.wind){for(const s of e.tumbleweeds)s.x+=s.speed*s.direction*t,s.rotation+=s.speed*3*t;if(e.tumbleweeds=e.tumbleweeds.filter(s=>Math.abs(s.x)<4&&s.z>e.player.position-500),Math.random()<.015){const s=e.windState.currentDirection||(Math.random()>.5?1:-1);e.tumbleweeds.push({x:s>0?-3.5:3.5,z:e.player.position+e.config.drawDistance*e.config.segmentLength,rotation:0,speed:.5+Math.random()*.5,direction:s})}for(const s of e.tumbleweeds)Math.abs(e.player.x-s.x)<.15&&(e.player.x+=s.direction*.02,e.player.speed*=.995)}},bt=(e,t)=>{const s=e.currentTheme;if(!s?.effects.lightning)return;const n=s.effects.lightning;e.lightningTimer+=t*1e3,e.lightningActive?e.lightningTimer>n.duration&&(e.lightningActive=!1,e.lightningTimer=0):e.lightningTimer>n.interval&&Math.random()<.05&&(e.lightningActive=!0,e.lightningTimer=0)},Et=(e,t)=>{const s=e.currentTheme;if(!s?.physics.slippery){e.slideVelocity*=.9;return}const{input:n,player:o}=e;n.left?e.slideVelocity-=.02*(1-s.physics.grip):n.right&&(e.slideVelocity+=.02*(1-s.physics.grip)),o.x+=e.slideVelocity*t*20,e.slideVelocity*=.98,e.slideVelocity=Qe(e.slideVelocity,-.3,.3)},Mt=()=>({left:!1,right:!1,faster:!1,slower:!1}),Ht=()=>({currentForce:0,currentDirection:0,gustTimer:0,gusting:!1,gustDuration:0,extremeWindTimer:0,extremeWindActive:!1}),_t=()=>({active:!1,startTime:0,duration:0,peakHeight:0}),Gt=(e=1)=>{const t=Es(),s=1/Math.tan(100/2*Math.PI/180),n=bs(1e3,s),o=Rs(t.segmentLength,t.rumbleLength,n),i=gs(),r=[],a=[];for(let d=0;d<e;d++)r.push(mt(n)),a.push(Mt());const c=r[0]??mt(n),l=a[0]??Mt();return{config:t,baseConfig:{...t},player:c,input:l,players:r,inputs:a,cars:[],segments:i,trackLength:o,skyOffset:0,hillOffset:0,treeOffset:0,currentLapTime:0,lastLapTime:null,fastLapTime:null,currentTheme:null,windState:Ht(),jumpState:_t(),particles:[],tumbleweeds:[],slideVelocity:0,lightningActive:!1,lightningTimer:0,playerCount:e}},ws=(e,t)=>{e.cars=[];for(let s=0;s<t;s++){const n=Math.random()*fe([-.8,.8]),o=Math.floor(Math.random()*e.segments.length)*e.config.segmentLength,i=fe(ye.CARS),r=e.config.maxSpeed,a=r/4+Math.random()*r/(i===ye.CARS[4]?4:2),c={offset:n,z:o,sprite:i,speed:a};se(c.z,e.config.segmentLength).cars.push(c),e.cars.push(c)}},Is=(e,t,s,n,o,i,r,a,c)=>{const d=e.sprite.w*te;if(t.index-s.index>a)return 0;for(let h=1;h<20;h++){const p=(t.index+h)%c.length,g=c[p];if(g){if(g===s&&e.speed>i&&we(n,o,e.offset,d,1.2))return(n>.5?-1:n<-.5||e.offset>n?1:-1)*(1/h)*((e.speed-i)/r);for(const u of g.cars){const R=u.sprite.w*te;if(e.speed>u.speed&&we(e.offset,d,u.offset,R,1.2))return(u.offset>.5?-1:u.offset<-.5||e.offset>u.offset?1:-1)*(1/h)*((e.speed-u.speed)/r)}}}return e.offset<-.9?.1:e.offset>.9?-.1:0},ks=(e,t,s)=>{const{segmentLength:n,drawDistance:o,maxSpeed:i}=e.config;for(const r of e.cars){const a=se(r.z,n);r.offset+=Is(r,a,t,e.player.x,s,e.player.speed,i,o,e.segments),r.z=le(r.z,1/e.config.fps*r.speed,e.trackLength),r.percent=Re(r.z,n);const c=se(r.z,n);if(a!==c){const l=a.cars.indexOf(r);l>=0&&a.cars.splice(l,1),c.cars.push(r)}}},vt=(e,t)=>{const{config:s,player:n,input:o}=e,{segmentLength:i,maxSpeed:r,accel:a,braking:c,decel:l,offRoadDecel:d,offRoadLimit:h,centrifugal:p,lanes:g}=s,u=se(n.position+n.z,i),R=ye.CARS[0].w*te,E=n.speed/r,w=t*2*E,N=n.position;if(ks(e,u,R),n.position=le(n.position,t*n.speed,e.trackLength),o.left?n.x-=w:o.right&&(n.x+=w),n.x-=w*E*u.curve*p,o.faster?n.speed=Pe(n.speed,a,t):o.slower?n.speed=Pe(n.speed,c,t):n.speed=Pe(n.speed,l,t),n.x<-1||n.x>1){n.speed>h&&(n.speed=Pe(n.speed,d,t));for(const A of u.sprites){const F=A.source.w*te,Z=A.offset+F/2*(A.offset>0?1:-1);if(we(n.x,R,Z,F)){n.speed=r/5,n.position=le(u.p1.world.z,-n.z,e.trackLength);break}}}for(const A of u.cars){const F=A.sprite.w*te;if(n.speed>A.speed&&we(n.x,R,A.offset,F,.8)){n.speed=A.speed*(A.speed/n.speed),n.position=le(A.z,-n.z,e.trackLength),e.onCollision&&e.onCollision(.7);break}}n.x=Qe(n.x,-3,3),n.speed=Qe(n.speed,0,r);const _=(n.position-N)/i;e.skyOffset=le(e.skyOffset,.001*u.curve*_,1),e.hillOffset=le(e.hillOffset,.002*u.curve*_,1),e.treeOffset=le(e.treeOffset,.003*u.curve*_,1),n.position>n.z&&(e.currentLapTime>0&&N<n.z?(e.lastLapTime=e.currentLapTime,e.currentLapTime=0):e.currentLapTime+=t)},As=(e,t)=>{(t===k.LEFT||t===k.A)&&(e.input.left=!0),(t===k.RIGHT||t===k.D)&&(e.input.right=!0),(t===k.UP||t===k.W)&&(e.input.faster=!0),(t===k.DOWN||t===k.S)&&(e.input.slower=!0)},Cs=(e,t)=>{(t===k.LEFT||t===k.A)&&(e.input.left=!1),(t===k.RIGHT||t===k.D)&&(e.input.right=!1),(t===k.UP||t===k.W)&&(e.input.faster=!1),(t===k.DOWN||t===k.S)&&(e.input.slower=!1)},Ut=(e,t,s,n,o=3)=>{const i=["#dc2626","#3b82f6","#f59e0b","#10b981"],r=[];for(const a of e){let c=t-a.z;if(c<0&&(c+=s),c>0&&c<n){const l=Math.floor(Math.abs(a.offset*10))%i.length,d=Math.min(1,c/n);r.push({offset:a.offset,distance:d,color:i[l]??"#dc2626"})}}return r.sort((a,c)=>c.distance-a.distance),r.slice(0,o)},Ne=(e,t,s,n,o,i,r,a,c,l)=>{e.fillStyle=l,e.beginPath(),e.moveTo(t,s),e.lineTo(n,o),e.lineTo(i,r),e.lineTo(a,c),e.closePath(),e.fill()},Lt=(e,t)=>e/Math.max(6,2*t),wt=(e,t)=>e/Math.max(32,8*t),Ft=(e,t,s,n,o,i,r,a,c,l,d)=>{const h=Lt(i,s),p=Lt(c,s),g=wt(i,s),u=wt(c,s);if(e.fillStyle=d.grass,e.fillRect(0,a,t,o-a),Ne(e,n-i-h,o,n-i,o,r-c,a,r-c-p,a,d.rumble),Ne(e,n+i+h,o,n+i,o,r+c,a,r+c+p,a,d.rumble),Ne(e,n-i,o,n+i,o,r+c,a,r-c,a,d.road),d.lane){const R=i*2/s,E=c*2/s;let w=n-i+R,N=r-c+E;for(let _=1;_<s;_++)Ne(e,w-g/2,o,w+g/2,o,N+u/2,a,N-u/2,a,d.lane),w+=R,N+=E}Wt(e,0,o,t,a-o,l)},Wt=(e,t,s,n,o,i,r=de.FOG)=>{i<1&&(e.globalAlpha=1-i,e.fillStyle=r,e.fillRect(t,s,n,o),e.globalAlpha=1)},Ds=(e,t,s,n)=>{e.globalAlpha=n,e.fillStyle="#ffffff",e.fillRect(0,0,t,s),e.globalAlpha=1},Os=(e,t,s)=>{for(const n of t){if(e.globalAlpha=n.life,n.sprite&&s.has(n.sprite)){const o=s.get(n.sprite);e.drawImage(o.canvas,n.x-n.size,n.y-n.size,n.size*2,n.size*2)}else{e.fillStyle=n.sprite?.includes("rain")?"rgba(150,180,220,0.6)":"#ffffff";const o=n.sprite?.includes("rain")?n.size*4:n.size;e.fillRect(n.x,n.y,n.size,o)}e.globalAlpha=1}},Ps=(e,t,s)=>{if(!s)return;e.save(),e.translate(t.x,t.y),e.rotate(t.rotation);const n=80*t.scale;e.drawImage(s.canvas,-n/2,-n/2,n,n),e.restore()},Bs=(e,t,s,n,o="#000000",i=4)=>{e.fillStyle=o,e.fillRect(t-i/2,s,i,n)},We=(e,t,s,n,o,i,r,a=0,c=0,l=0,d=80,h=80)=>{const p=d*o*s/2*(te*n),g=h*o*s/2*(te*n),u=i+p*a,R=r+g*c,E=l>0?Math.max(0,R+g-l):0;if(E<g){const w=t.height*(1-E/g);e.drawImage(t.canvas,0,0,t.width,w,u,R,p,g-E)}},et=(e,t,s,n,o,i,r,a,c,l,d)=>{const h=b.PLAYER_STRAIGHT.w,p=b.PLAYER_STRAIGHT.h,g=h*r*s/2*(te*o),u=p*r*s/2*(te*o),R=a-g/2,E=c-u+d;e.drawImage(t.canvas,R,E,g,u)},Yt=(e,t,s,n,o=0,i=0)=>{const r=t.width,a=t.height,c=Math.floor(r*o)%r,l=Math.min(r/2,r-c),d=Math.floor(s*(l/(r/2))),h=n;if(e.drawImage(t.canvas,c,0,l,a,0,i,d,h),l<r/2){const p=r/2-l,g=s-d;e.drawImage(t.canvas,0,0,p,a,d-1,i,g,h)}},Ns={PALM_TREE:"palm-tree.svg",TREE1:"tree-deciduous.svg",TREE2:"tree-blossom.svg",DEAD_TREE1:"dead-tree.svg",DEAD_TREE2:"tree-twisting.svg",BUSH1:"bush-fern.svg",BUSH2:"bush-flowering.svg",CACTUS:"cactus.svg",STUMP:"stump.svg",COLUMN:"column.svg",BOULDER1:"rocks-flat.svg",BOULDER2:"rocks-flat.svg",BOULDER3:"dead-tree.svg",BILLBOARD01:"billboard-liquidplanner.svg",BILLBOARD02:"billboard-icecream.svg",BILLBOARD03:"billboard-codeincomplete.svg",BILLBOARD04:"billboard-rim.svg",BILLBOARD05:"billboard-danke.svg",BILLBOARD06:"billboard-liquidplanner.svg",BILLBOARD07:"billboard-sega.svg",BILLBOARD08:"billboard-snakes.svg",BILLBOARD09:"billboard-redmond.svg",CAR01:"car-red.svg",CAR02:"car-brown.svg",CAR03:"car-pink.svg",CAR04:"car-blue.svg",SEMI:"truck-semi.svg",TRUCK:"truck-jeep.svg",PLAYER_STRAIGHT:"player-car.svg",PLAYER_LEFT:"player-car-left.svg",PLAYER_RIGHT:"player-car-right.svg",PLAYER_UPHILL_STRAIGHT:"player-car.svg",PLAYER_UPHILL_LEFT:"player-car-left.svg",PLAYER_UPHILL_RIGHT:"player-car-right.svg"},Hs={basePath:"./sprites/",defaultScales:[.25,.5,1,2]};class _s{cache=new Map;config;svgCache=new Map;constructor(t={}){this.config={...Hs,...t}}async loadSVG(t){if(this.svgCache.has(t))return this.svgCache.get(t);const s=await fetch(t);if(!s.ok)throw new Error(`Failed to load SVG: ${t}`);const n=await s.text();return this.svgCache.set(t,n),n}async renderSVGToCanvas(t,s){return new Promise((n,o)=>{const i=new Image,r=new Blob([t],{type:"image/svg+xml;charset=utf-8"}),a=URL.createObjectURL(r);i.onload=()=>{const c=Math.ceil(i.naturalWidth*s),l=Math.ceil(i.naturalHeight*s),d=document.createElement("canvas");d.width=c,d.height=l;const h=d.getContext("2d");if(!h){URL.revokeObjectURL(a),o(new Error("Failed to get canvas context"));return}h.drawImage(i,0,0,c,l),URL.revokeObjectURL(a),n({canvas:d,width:c,height:l,scale:s})},i.onerror=()=>{URL.revokeObjectURL(a),o(new Error(`Failed to render SVG at scale ${s}`))},i.src=a})}async preload(t,s){const n=t.startsWith("/")?t:this.config.basePath+t,o=await this.loadSVG(n);this.cache.has(t)||this.cache.set(t,new Map);const i=this.cache.get(t);await Promise.all(s.map(async r=>{if(!i.has(r)){const a=await this.renderSVGToCanvas(o,r);i.set(r,a)}}))}get(t,s){const n=this.cache.get(t);if(!n)return null;const o=n.get(s);if(o)return o;let i=0,r=1/0;for(const a of n.keys()){const c=Math.abs(a-s);c<r&&a>=s&&(r=c,i=a)}if(i>0)return n.get(i);for(const a of n.keys()){const c=Math.abs(a-s);c<r&&(r=c,i=a)}return n.get(i)??null}clear(){this.cache.clear()}}const Gs=e=>new _s(e),K=Gs(),Ye=(e,t)=>{const s=Ns[e];return s?K.get(s,t):null},Us=async()=>{const e=[.5,1,1.5,2,3],t=[.5,1,1.5,2,3,4],s=[.5,1,1.5,2],n=[{path:"player-car.svg",scales:t},{path:"player-car-left.svg",scales:t},{path:"player-car-right.svg",scales:t},{path:"car-jump.svg",scales:t},{path:"background-level-1.svg",scales:[1,2]},{path:"background.svg",scales:[1,2]},{path:"main-menu.svg",scales:[1.5,2]},{path:"music-selection.svg",scales:[1.5,2]},{path:"track-builder.svg",scales:[1,1.5,2]},{path:"palm-tree.svg",scales:t},{path:"tree-deciduous.svg",scales:t},{path:"tree-blossom.svg",scales:t},{path:"tree-twisting.svg",scales:t},{path:"dead-tree.svg",scales:t},{path:"bush-fern.svg",scales:e},{path:"bush-flowering.svg",scales:e},{path:"cactus.svg",scales:e},{path:"stump.svg",scales:e},{path:"column.svg",scales:t},{path:"rocks-flat.svg",scales:e},{path:"billboard-snakes.svg",scales:t},{path:"billboard-redmond.svg",scales:t},{path:"billboard-liquidplanner.svg",scales:t},{path:"billboard-sega.svg",scales:t},{path:"billboard-danke.svg",scales:t},{path:"billboard-rim.svg",scales:e},{path:"billboard-codeincomplete.svg",scales:e},{path:"billboard-icecream.svg",scales:e},{path:"car-red.svg",scales:t},{path:"car-pink.svg",scales:t},{path:"car-blue.svg",scales:t},{path:"car-brown.svg",scales:t},{path:"truck-semi.svg",scales:t},{path:"truck-jeep.svg",scales:t},{path:"snowflake.svg",scales:s},{path:"raindrop.svg",scales:s},{path:"lightning.svg",scales:e},{path:"tumbleweed.svg",scales:e},{path:"traffic-cone.svg",scales:e},{path:"barrier.svg",scales:e},{path:"oil-slick.svg",scales:e},{path:"water-splash.svg",scales:s},{path:"turbo-zone.svg",scales:e},{path:"laser-beam.svg",scales:e},{path:"theme-night.svg",scales:[.5,1]},{path:"theme-fog.svg",scales:[.5,1]},{path:"theme-snow.svg",scales:[.5,1]},{path:"theme-storm.svg",scales:[.5,1]},{path:"theme-desert.svg",scales:[.5,1]},{path:"theme-future.svg",scales:[.5,1]},{path:"theme-marsh.svg",scales:[.5,1]},{path:"theme-mountains.svg",scales:[.5,1]},{path:"theme-lakes.svg",scales:[.5,1]},{path:"theme-country.svg",scales:[.5,1]},{path:"theme-city.svg",scales:[.5,1]},{path:"theme-roadworks.svg",scales:[.5,1]},{path:"theme-windy.svg",scales:[.5,1]}];await Promise.all(n.map(o=>K.preload(o.path,o.scales)))},Fs={volume:.5,loop:!0};class Ws{audioContext=null;gainNode=null;audioBuffer=null;sourceNode=null;currentUrl=null;loaded=!1;playing=!1;config;volume;constructor(t={}){this.config={...Fs,...t},this.volume=this.config.volume}getAudioContext(){return this.audioContext||(this.audioContext=new AudioContext,this.gainNode=this.audioContext.createGain(),this.gainNode.connect(this.audioContext.destination),this.gainNode.gain.value=this.volume),this.audioContext}async load(t){if(this.currentUrl===t&&this.audioBuffer)return;const n=await(await fetch(t)).arrayBuffer(),o=this.getAudioContext();this.audioBuffer=await o.decodeAudioData(n),this.currentUrl=t,this.loaded=!0}async play(){if(!this.audioBuffer)return;const t=this.getAudioContext();t.state==="suspended"&&await t.resume(),this.sourceNode&&(this.sourceNode.stop(),this.sourceNode.disconnect()),this.sourceNode=t.createBufferSource(),this.sourceNode.buffer=this.audioBuffer,this.sourceNode.loop=this.config.loop,this.sourceNode.connect(this.gainNode),this.sourceNode.start(0),this.playing=!0,this.sourceNode.onended=()=>{this.playing=!1}}pause(){this.sourceNode&&this.playing&&(this.sourceNode.stop(),this.sourceNode.disconnect(),this.sourceNode=null,this.playing=!1)}stop(){this.sourceNode&&(this.sourceNode.stop(),this.sourceNode.disconnect(),this.sourceNode=null),this.playing=!1}setVolume(t){this.volume=Math.max(0,Math.min(1,t)),this.gainNode&&(this.gainNode.gain.value=this.volume)}getVolume(){return this.volume}isPlaying(){return this.playing}isLoaded(){return this.loaded}}const Ee=new Ws,Ie=async e=>{Me(),await Ee.load(e),await Ee.play()},Me=()=>{Ee.stop()},ve=e=>{Ee.setVolume(e)};let ie=!0,_e=null,$=null,Q=null,qe=null,J=null,ee=null;const Ys=()=>ie,Xt=()=>{if(ie=!ie,!ie)Me(),ot();else{const e=Ee.getVolume();e>0&&Ee.setVolume(e)}return ie},zt=()=>(_e||(_e=new AudioContext),_e),Xs=e=>{const t=e.sampleRate*2,s=e.createBuffer(1,t,e.sampleRate),n=s.getChannelData(0);for(let o=0;o<t;o++)n[o]=Math.random()*2-1;return s},zs=()=>{if(ie)try{const e=zt();e.state==="suspended"&&e.resume(),ot(),$=e.createOscillator(),$.type="sawtooth",$.frequency.value=50,Q=e.createGain(),Q.gain.value=.06,qe||(qe=Xs(e)),J=e.createBufferSource(),J.buffer=qe,J.loop=!0;const t=e.createBiquadFilter();t.type="lowpass",t.frequency.value=200,ee=e.createGain(),ee.gain.value=.03,$.connect(Q),Q.connect(e.destination),J.connect(t),t.connect(ee),ee.connect(e.destination),$.start(),J.start()}catch(e){console.error("Failed to start engine sound:",e)}},ot=()=>{try{$&&($.stop(),$.disconnect(),$=null),J&&(J.stop(),J.disconnect(),J=null),Q&&(Q.disconnect(),Q=null),ee&&(ee.disconnect(),ee=null)}catch{}},It=e=>{if(!(!ie||!$||!Q))try{const t=_e;if(!t)return;const s=50+e*150;$.frequency.setValueAtTime(s,t.currentTime);const n=.03+e*.09;if(Q.gain.setValueAtTime(n,t.currentTime),ee){const o=.012+e*.048;ee.gain.setValueAtTime(o,t.currentTime)}}catch{}},Vt=(e=1)=>{if(ie)try{const t=zt();t.state==="suspended"&&t.resume();const s=t.sampleRate*.3,n=t.createBuffer(1,s,t.sampleRate),o=n.getChannelData(0);for(let c=0;c<s;c++){const l=1-c/s;o[c]=(Math.random()*2-1)*l*e}const i=t.createBufferSource();i.buffer=n;const r=t.createBiquadFilter();r.type="lowpass",r.frequency.value=800;const a=t.createGain();a.gain.value=Math.min(.5,.2*e),i.connect(r),r.connect(a),a.connect(t.destination),i.start(),i.onended=()=>{i.disconnect(),r.disconnect(),a.disconnect()}}catch(t){console.error("Failed to play collision sound:",t)}},it=45,Vs=3,$s=3,Ks=20,Zs=25,kt=100,tt=4,js=.15,qs=30,xs=(e,t)=>{const s=Math.floor(e/t),n=Math.floor(s*js);return Math.max(qs,n)},$t=(e=0,t=200)=>{const s=e>0?xs(e,t):it;return{screen:"main-menu",playerName:"PLAYER 1",selectedTrack:0,gameMode:"time",timeLimit:s,currentTime:s,score:0,lap:1,totalLaps:Vs,checkpointsPassed:0,totalCheckpoints:tt,lastCheckpointSegment:-1,isPaused:!1,isGameOver:!1,bestTime:null,bestScore:null,timeBonusFlash:0}},Js=(e,t)=>{if(e.isPaused||e.isGameOver||e.screen!=="racing")return e;const s=Math.max(0,e.timeBonusFlash-t);if(e.gameMode==="race")return{...e,currentTime:e.currentTime+t,timeBonusFlash:s};const n=e.currentTime-t;return n<=0?{...e,currentTime:0,isGameOver:!0,screen:"results",timeBonusFlash:0}:{...e,currentTime:n,timeBonusFlash:s}},Qs=(e,t,s,n)=>{if(e.isPaused||e.isGameOver)return{state:e,bonusAwarded:0};const o=Math.floor(t/n),i=Math.floor(s/n),r=Math.floor(i/(tt+1)),a=Math.floor(o/r);if(a>e.lastCheckpointSegment&&a<=tt){const c=e.gameMode==="race"?0:$s;return{state:{...e,currentTime:e.currentTime+c,score:e.score+Zs,checkpointsPassed:a,lastCheckpointSegment:a,timeBonusFlash:e.gameMode==="race"?0:1.5},bonusAwarded:c}}return{state:e,bonusAwarded:0}},en=(e,t)=>{const s=e.lap+1;if(s>e.totalLaps){if(e.gameMode==="race"){const i=e.bestTime===null||t.currentLapTime<e.bestTime;return{...e,isGameOver:!0,screen:"results",score:e.score,bestScore:e.bestScore,bestTime:i?t.currentLapTime:e.bestTime,timeBonusFlash:0}}const n=e.score+Math.floor(e.currentTime*50)+kt,o=e.bestScore===null||n>e.bestScore;return{...e,isGameOver:!0,screen:"results",score:n,bestScore:o?n:e.bestScore,bestTime:o?t.currentLapTime:e.bestTime,timeBonusFlash:0}}return e.gameMode==="race"?{...e,lap:s,checkpointsPassed:0,lastCheckpointSegment:0,timeBonusFlash:2}:{...e,lap:s,currentTime:e.currentTime+Ks,score:e.score+kt,checkpointsPassed:0,lastCheckpointSegment:0,timeBonusFlash:2}},tn=e=>({...e,screen:"racing",currentTime:e.gameMode==="race"?0:e.timeLimit,score:0,lap:1,checkpointsPassed:0,lastCheckpointSegment:0,isPaused:!1,isGameOver:!1,timeBonusFlash:0}),sn=e=>({...e,isPaused:!0}),nn=e=>({...e,isPaused:!1}),on=e=>({...$t(),bestTime:e.bestTime,bestScore:e.bestScore}),Kt=e=>{const t=Math.floor(e/60),s=Math.floor(e%60),n=Math.floor(e%1*10);return`${t}:${s.toString().padStart(2,"0")}.${n}`},rn=e=>e.toString().padStart(6,"0"),Zt=e=>({...e,gameMode:e.gameMode==="time"?"race":"time"}),an=3,cn=3,ln=e=>({playerId:e,position:0,lap:1,lastLapTime:null,finished:!1,finishTime:null,rank:0}),jt=e=>({playerStates:Array.from({length:e},(t,s)=>ln(s)),winner:null,isPaused:!1,countdown:cn,countdownTimer:0}),fn=(e=1)=>({screen:"main-menu",isPaused:!1,isGameOver:!1,raceState:jt(e),playerCount:e,totalLaps:an}),dn=(e,t)=>{if(e.screen!=="racing"||e.isPaused)return e;const s=e.raceState;return s.countdown>0?(s.countdownTimer+=t,s.countdownTimer>=1&&(s.countdown--,s.countdownTimer=0),{...e}):e},hn=(e,t,s)=>{if(e.screen!=="racing"||e.isPaused||e.isGameOver)return e;const n=e.raceState.playerStates[t];if(!n||n.finished)return e;const o=s.players[t];if(!o)return e;const i=n.position;if(n.position=o.position,i>s.trackLength*.8&&o.position<s.player.z&&(n.lap++,n.lastLapTime=s.currentLapTime,n.lap>e.totalLaps)){n.finished=!0,n.finishTime=Date.now();const r=e.raceState.playerStates.filter(c=>c.finished).length;n.rank=r,e.raceState.winner===null&&(e.raceState.winner=t),e.raceState.playerStates.every(c=>c.finished)&&(e.isGameOver=!0,e.screen="race-results")}return{...e}},gn=(e,t=1)=>({...e,screen:"racing",isPaused:!1,isGameOver:!1,raceState:jt(t),playerCount:t}),un={left:[k.A],right:[k.D],faster:[k.W],slower:[k.S]},pn={left:[k.LEFT],right:[k.RIGHT],faster:[k.UP],slower:[k.DOWN]};class qt{playerConfigs;constructor(t=1){this.playerConfigs=[un,...t>1?[pn]:[]]}setPlayerConfig(t,s){t>=0&&t<this.playerConfigs.length&&(this.playerConfigs[t]=s)}getPlayerConfig(t){return this.playerConfigs[t]??null}getPlayerForKey(t){for(let s=0;s<this.playerConfigs.length;s++){const n=this.playerConfigs[s];if(n&&(n.left.includes(t)||n.right.includes(t)||n.faster.includes(t)||n.slower.includes(t)))return s}return-1}handleKeyDown(t,s){for(let n=0;n<this.playerConfigs.length;n++){const o=this.playerConfigs[n],i=t[n];!o||!i||(o.left.includes(s)&&(i.left=!0),o.right.includes(s)&&(i.right=!0),o.faster.includes(s)&&(i.faster=!0),o.slower.includes(s)&&(i.slower=!0))}}handleKeyUp(t,s){for(let n=0;n<this.playerConfigs.length;n++){const o=this.playerConfigs[n],i=t[n];!o||!i||(o.left.includes(s)&&(i.left=!1),o.right.includes(s)&&(i.right=!1),o.faster.includes(s)&&(i.faster=!1),o.slower.includes(s)&&(i.slower=!1))}}}const At=.5,mn=200,Sn=(e,t,s=200)=>{let n=e.position-t.position;return Math.abs(n)>s*100||Math.abs(n)>mn?!1:we(e.x,At,t.x,At,.8)},Tn=(e,t)=>{const s=e.x-t.x,n=e.position-t.position,o=Math.sqrt(s*s+n*n);if(o===0)return;const i=.15,r=s/o;e.x+=r*i,t.x-=r*i,n>0&&e.speed>t.speed?e.speed=t.speed*.9:n<0&&t.speed>e.speed&&(t.speed=e.speed*.9),e.speed=Math.max(0,e.speed*.95),t.speed=Math.max(0,t.speed*.95)},yn=(e,t=200)=>{const s=[];for(let n=0;n<e.length;n++)for(let o=n+1;o<e.length;o++){const i=e[n],r=e[o];if(!(!i||!r)&&Sn(i,r,t)){const a=i.x-r.x,c=i.position-r.position,l=Math.sqrt(a*a+c*c);s.push({p1:n,p2:o,distance:l,dx:a,dz:c})}}return s},Rn=(e,t=200,s)=>{const n=yn(e,t);for(const o of n){const i=e[o.p1],r=e[o.p2];i&&r&&(Tn(i,r),s&&s(.8))}},z={background:"#1a1a2e",panel:"#16213e",accent:"#0f3460",highlight:"#e94560",text:"#eaeaea",textDim:"#888888",timer:"#ffcc00",score:"#00ff88",selection:"#e53935"},bn=(e,t,s,n,o)=>{e.fillStyle=z.panel,e.fillRect(t,s,n,o),e.strokeStyle=z.accent,e.lineWidth=2,e.strokeRect(t,s,n,o)},En=(e,t,s,n,o={})=>{const{font:i="16px monospace",color:r=z.text,align:a="left",baseline:c="top"}=o;e.font=i,e.fillStyle=r,e.textAlign=a,e.textBaseline=c,e.fillText(t,s,n)},x=(e,t,s,n,o={})=>{En(e,t,s,n,{...o,align:"center"})},Mn=(e,t)=>{e.strokeStyle=z.selection,e.lineWidth=5,e.strokeRect(t.x,t.y,t.width,t.height),e.shadowColor=z.selection,e.shadowBlur=10,e.strokeRect(t.x,t.y,t.width,t.height),e.shadowBlur=0},vn=[{svgX:30,svgY:40,svgW:180,svgH:80,action:"player1",row:0,col:0},{svgX:230,svgY:40,svgW:340,svgH:80,action:"start",row:0,col:1},{svgX:590,svgY:40,svgW:180,svgH:80,action:"player2",row:0,col:2},{svgX:30,svgY:140,svgW:180,svgH:90,action:"gears-p1",row:1,col:0},{svgX:230,svgY:140,svgW:340,svgH:90,action:"game",row:1,col:1},{svgX:590,svgY:140,svgW:180,svgH:90,action:"gears-p2",row:1,col:2},{svgX:30,svgY:250,svgW:180,svgH:90,action:"accel-p1",row:2,col:0},{svgX:230,svgY:250,svgW:340,svgH:90,action:"course",row:2,col:1},{svgX:590,svgY:250,svgW:180,svgH:90,action:"accel-p2",row:2,col:2},{svgX:30,svgY:360,svgW:240,svgH:80,action:"control",row:3,col:0},{svgX:290,svgY:360,svgW:260,svgH:80,action:"players",row:3,col:1},{svgX:570,svgY:360,svgW:200,svgH:80,action:"sound",row:3,col:2},{svgX:30,svgY:460,svgW:240,svgH:80,action:"constructor",row:4,col:0},{svgX:290,svgY:460,svgW:260,svgH:80,action:"code",row:4,col:1},{svgX:570,svgY:460,svgW:200,svgH:80,action:"define",row:4,col:2}],Se=["start","game","course","control","players","sound","constructor","code","define"];class Ln{constructor(t,s){this.width=t,this.height=s,this.buttons=[],this.zones=this.calculateZones(),this.selectedIndex=this.zones.findIndex(n=>Se.includes(n.action)),this.selectedIndex<0&&(this.selectedIndex=0)}buttons;zones;selectedIndex=0;playerCount=1;gameMode="time";getPlayerCount(){return this.playerCount}getGameMode(){return this.gameMode}togglePlayerCount(){this.playerCount=this.playerCount===1?2:1}toggleGameMode(){this.gameMode=this.gameMode==="time"?"race":"time"}calculateZones(){const t=this.width/800,s=this.height/600;return vn.map(n=>({x:n.svgX*t,y:n.svgY*s,width:n.svgW*t,height:n.svgH*s,action:n.action,row:n.row,col:n.col}))}render(t,s){const n=this.width/800,o=K.get("main-menu.svg",n);if(o)t.drawImage(o.canvas,0,0,this.width,this.height);else{t.fillStyle="#1a1c20",t.fillRect(0,0,this.width,this.height),x(t,"LOADING...",this.width/2,this.height/2,{font:"bold 32px monospace",color:"#a0a0a0"});return}const i=this.zones[this.selectedIndex];i&&Mn(t,i);const r=this.zones.find(c=>c.action==="players");if(r){const c=this.playerCount===1?"1 PLAYER":"2 PLAYERS";x(t,c,r.x+r.width/2,r.y+r.height/2,{font:`bold ${14*n}px monospace`,color:"#ffcc00"})}const a=this.zones.find(c=>c.action==="game");if(a){const c=this.gameMode==="time"?"TIME MODE":"RACE MODE";x(t,c,a.x+a.width/2,a.y+a.height/2+25*n,{font:`bold ${12*n}px monospace`,color:"#4caf50"})}this.drawSpeakerIcon(t,n)}drawSpeakerIcon(t,s){const n=this.zones.find(a=>a.action==="sound");if(!n)return;const o=n.x+n.width/2,i=n.y+n.height/2+10*s,r=30*s;t.save(),t.strokeStyle="#fdd835",t.fillStyle="#fdd835",t.lineWidth=3*s,t.lineCap="round",t.lineJoin="round",t.beginPath(),t.moveTo(o-r*.5,i+r*.4),t.lineTo(o-r*.5,i-r*.4),t.lineTo(o+r*.2,i-r*.5),t.lineTo(o+r*.2,i+r*.5),t.closePath(),t.fill(),t.fillRect(o-r*.7,i-r*.25,r*.25,r*.5),Ys()?(t.strokeStyle="#fff",t.lineWidth=2*s,t.beginPath(),t.arc(o+r*.3,i,r*.25,-Math.PI/3,Math.PI/3),t.stroke(),t.beginPath(),t.arc(o+r*.3,i,r*.45,-Math.PI/3,Math.PI/3),t.stroke()):(t.strokeStyle="#e53935",t.lineWidth=4*s,t.beginPath(),t.moveTo(o+r*.1,i-r*.35),t.lineTo(o+r*.7,i+r*.35),t.moveTo(o+r*.7,i-r*.35),t.lineTo(o+r*.1,i+r*.35),t.stroke(),t.fillStyle="#e53935",t.font=`bold ${10*s}px monospace`,t.textAlign="center",t.fillText("OFF",o+r*.5,i+r*.6)),t.restore()}findZoneIndex(t,s){return this.zones.findIndex(n=>t>=n.x&&t<=n.x+n.width&&s>=n.y&&s<=n.y+n.height)}handleClick(t,s){const n=this.findZoneIndex(t,s);if(n>=0){const o=this.zones[n];if(o)return o.action==="players"?(this.togglePlayerCount(),null):o.action==="game"?(this.toggleGameMode(),null):o.action}return null}handleMouseMove(t,s){const n=this.findZoneIndex(t,s),o=this.zones[n];n>=0&&o&&Se.includes(o.action)&&(this.selectedIndex=n)}handleKeyDown(t){const s=this.zones[this.selectedIndex];if(!s)return null;const{UP:n,DOWN:o,LEFT:i,RIGHT:r,SPACE:a}={UP:38,DOWN:40,LEFT:37,RIGHT:39,SPACE:32};if(t===a||t===13)return s.action==="players"?(this.togglePlayerCount(),null):s.action==="game"?(this.toggleGameMode(),null):s.action;let c=[];if(t===n?c=this.zones.filter(l=>Se.includes(l.action)&&l.row<s.row):t===o?c=this.zones.filter(l=>Se.includes(l.action)&&l.row>s.row):t===i?c=this.zones.filter(l=>Se.includes(l.action)&&l.col<s.col&&l.row===s.row):t===r&&(c=this.zones.filter(l=>Se.includes(l.action)&&l.col>s.col&&l.row===s.row)),c.length>0){t===n||t===i?c.sort((d,h)=>t===n?h.row-d.row:h.col-d.col):c.sort((d,h)=>t===o?d.row-h.row:d.col-h.col);const l=c[0];if(l){const d=this.zones.indexOf(l);d>=0&&(this.selectedIndex=d)}}return null}getZones(){return this.zones}getButtons(){return this.buttons}}const oe=[{id:"esprit",name:"ESPRIT THEME",file:"./sound/Esprit_Theme.mp3"},{id:"velocity",name:"VELOCITY VORTEX",file:"./sound/Velocity_Vortex.mp3"},{id:"nebula",name:"NEBULA NAVIGATOR",file:"./sound/Nebula_Navigator.mp3"},{id:"neon",name:"NEON DRIVE",file:"./sound/Neon_Drive.mp3"},{id:"neon2",name:"NEON VELOCITY",file:"./sound/Neon_Velocity.mp3"},{id:"silent",name:"NO MUSIC",file:""}];class wn{constructor(t,s){this.width=t,this.height=s}selectedIndex=4;getSelectedTrack(){return oe[this.selectedIndex]??oe[0]}getSelectedChannel(){return this.getSelectedTrack().id}render(t,s){const n=this.width/800,o=K.get("music-selection.svg",n);o?t.drawImage(o.canvas,0,0,this.width,this.height):(t.fillStyle="#d2b48c",t.fillRect(0,0,this.width,this.height));const i=this.width/2,r=oe[this.selectedIndex];if(r){const a=110*(this.height/600);t.fillStyle="rgba(0, 0, 0, 0.6)",t.fillRect(i-200,a-30,400,50),t.font=`bold ${28*(this.height/600)}px monospace`,t.fillStyle="#ff8c00",t.textAlign="center",t.textBaseline="middle",t.shadowColor="#ff8c00",t.shadowBlur=10,t.fillText(r.name,i,a),t.shadowBlur=0}t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(this.width/2-160,this.height-80,320,40),t.font=`bold ${16*(this.height/600)}px monospace`,t.fillStyle="#ff8c00",t.textAlign="center",t.textBaseline="middle",t.fillText("LEFT/RIGHT: SELECT   SPACE/ENTER: START",this.width/2,this.height-60)}handleClick(t,s){return"start_game"}handleKeyDown(t){const{LEFT:s,RIGHT:n,SPACE:o}={LEFT:37,RIGHT:39,SPACE:32};return t===o||t===13?"start_game":(t===s?this.selectedIndex=(this.selectedIndex-1+oe.length)%oe.length:t===n&&(this.selectedIndex=(this.selectedIndex+1)%oe.length),null)}handleMouseMove(t,s){}getZones(){return[]}}const ce=[{id:"night",name:"NIGHT",icon:"theme-night.svg"},{id:"fog",name:"FOG",icon:"theme-fog.svg"},{id:"snow",name:"SNOW",icon:"theme-snow.svg"},{id:"storm",name:"STORM",icon:"theme-storm.svg"},{id:"desert",name:"DESERT",icon:"theme-desert.svg"},{id:"future",name:"FUTURE",icon:"theme-future.svg"},{id:"marsh",name:"MARSH",icon:"theme-marsh.svg"},{id:"mountains",name:"MOUNTAINS",icon:"theme-mountains.svg"},{id:"lakes",name:"LAKES",icon:"theme-lakes.svg"},{id:"country",name:"COUNTRY",icon:"theme-country.svg"},{id:"city",name:"CITY",icon:"theme-city.svg"},{id:"roadworks",name:"ROADWORKS",icon:"theme-roadworks.svg"},{id:"windy",name:"WINDY",icon:"theme-windy.svg"}],He=[{id:"curves",name:"CURVES",row:0,col:0},{id:"hills",name:"HILLS",row:0,col:1},{id:"scenery",name:"SCENERY",row:0,col:2},{id:"sharpness",name:"SHARPNESS",row:1,col:0},{id:"steepness",name:"STEEPNESS",row:1,col:1},{id:"scatter",name:"SCATTER",row:1,col:2},{id:"length",name:"LENGTH",row:2,col:0},{id:"difficulty",name:"DIFFICULTY",row:2,col:1},{id:"obstacles",name:"OBSTACLES",row:2,col:2}],ne=[{id:"type",name:"TYPE",x:30},{id:"exit",name:"EXIT",x:285},{id:"start",name:"START",x:540}];class In{constructor(t,s){this.width=t,this.height=s,this.config={themeId:"night",curves:50,hills:50,scenery:50,sharpness:50,steepness:50,scatter:50,length:50,difficulty:50,obstacles:50}}config;selectedRow=0;selectedCol=0;mode="top";getConfig(){return this.config}getSelectedThemeId(){return this.config.themeId}getSliderValue(t){const s=t,n=this.config[s];return typeof n=="number"?n:50}setSliderValue(t,s){const n=t;n in this.config&&(this.config[n]=Math.max(0,Math.min(100,s)))}render(t,s){const n=this.width/800,o=K.get("track-builder.svg",n);o?t.drawImage(o.canvas,0,0,this.width,this.height):(t.fillStyle="#1a1a1a",t.fillRect(0,0,this.width,this.height));const i=this.width/800,r=this.height/600;for(const g of He){const u=(30+g.col*255)*i,R=(120+g.row*100)*r,E=this.getSliderValue(g.id);this.mode==="sliders"&&this.selectedRow===g.row&&this.selectedCol===g.col&&(t.strokeStyle="#c1272d",t.lineWidth=3,t.strokeRect(u,R,230*i,85*r)),t.fillStyle="#ffca28",t.font=`bold ${14*Math.min(i,r)}px monospace`,t.textAlign="right",t.fillText(`${E}%`,u+215*i,R+32*r);const N=u+40*i,_=R+55*r,A=150*i,F=E/100*A;t.fillStyle="#c1272d",t.fillRect(N+2,_+2,F-4,8*r)}const a=430*r,c=46*i,l=75*r,d=54*i,h=53*i,p=ce.findIndex(g=>g.id===this.config.themeId);for(let g=0;g<ce.length;g++){const u=h+g*d,R=a+45*r,E=ce[g];if(E){const w=K.get(E.icon,Math.min(i,r));w?t.drawImage(w.canvas,u,R,c,l):(t.fillStyle="#222222",t.fillRect(u,R,c,l))}this.mode==="scenario"&&g===this.selectedCol?(t.strokeStyle="#c1272d",t.lineWidth=3,t.strokeRect(u-2,R-2,c+4,l+4)):g===p&&(t.strokeStyle="#00ff88",t.lineWidth=2,t.strokeRect(u-1,R-1,c+2,l+2))}for(let g=0;g<ne.length;g++){const u=ne[g];if(!u)continue;const R=u.x*i,E=20*r;this.mode==="top"&&this.selectedCol===g&&(t.strokeStyle="#c1272d",t.lineWidth=3,t.strokeRect(R,E,230*i,80*r))}t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(this.width/2-300,this.height-35,600,30),t.font=`bold ${11*Math.min(i,r)}px monospace`,t.fillStyle="#ffca28",t.textAlign="center",t.fillText("TAB: MODE   ARROWS: NAVIGATE   A/D: ADJUST   ENTER: SELECT",this.width/2,this.height-15)}handleClick(t,s){const n=this.width/800,o=this.height/600;for(let d=0;d<ne.length;d++){const h=ne[d];if(!h)continue;const p=h.x*n,g=20*o,u=230*n,R=80*o;if(t>=p&&t<=p+u&&s>=g&&s<=g+R)return h.id==="exit"?"back":h.id==="start"?"start_game":null}for(const d of He){const h=(30+d.col*255)*n,p=(120+d.row*100)*o,g=230*n,u=85*o;if(t>=h&&t<=h+g&&s>=p&&s<=p+u){const R=h+40*n,E=150*n,w=t-R,N=Math.round(w/E*100);return this.setSliderValue(d.id,Math.max(0,Math.min(100,N))),null}}const i=475*o,r=46*n,a=75*o,c=54*n,l=53*n;for(let d=0;d<ce.length;d++){const h=l+d*c;if(t>=h&&t<=h+r&&s>=i&&s<=i+a){const p=ce[d];return p&&(this.config.themeId=p.id),null}}return null}handleMouseMove(t,s){const n=this.width/800,o=this.height/600;for(const d of ne){if(!d)continue;const h=d.x*n,p=20*o,g=230*n,u=80*o;if(t>=h&&t<=h+g&&s>=p&&s<=p+u){this.mode="top",this.selectedCol=ne.indexOf(d);return}}for(const d of He){const h=(30+d.col*255)*n,p=(120+d.row*100)*o,g=230*n,u=85*o;if(t>=h&&t<=h+g&&s>=p&&s<=p+u){this.mode="sliders",this.selectedRow=d.row,this.selectedCol=d.col;return}}const i=475*o,r=46*n,a=75*o,c=54*n,l=53*n;for(let d=0;d<ce.length;d++){const h=l+d*c;if(t>=h&&t<=h+r&&s>=i&&s<=i+a){this.mode="scenario",this.selectedCol=d;return}}}getZones(){const t=this.width/800,s=this.height/600,n=[];for(let l=0;l<ne.length;l++){const d=ne[l];d&&n.push({x:d.x*t,y:20*s,width:230*t,height:80*s,action:d.id,row:0,col:l})}for(const l of He)n.push({x:(30+l.col*255)*t,y:(120+l.row*100)*s,width:230*t,height:85*s,action:l.id,row:l.row+1,col:l.col});const o=475*s,i=46*t,r=75*s,a=54*t,c=53*t;for(let l=0;l<ce.length;l++)n.push({x:c+l*a,y:o,width:i,height:r,action:`theme_${l}`,row:4,col:l});return n}}class kn{constructor(t,s){this.width=t,this.height=s}render(t,s){t.fillStyle=z.background,t.fillRect(0,0,this.width,this.height);const n=this.width/2,o=s.isGameOver?s.gameMode==="race"?"RACE COMPLETE":"GAME OVER":"RACE COMPLETE";x(t,o,n,100,{font:"bold 36px monospace",color:s.isGameOver&&s.gameMode==="time"?z.highlight:z.score}),bn(t,n-150,160,300,200),x(t,s.playerName,n,180,{font:"bold 24px monospace"}),x(t,`SCORE: ${s.score.toString().padStart(6,"0")}`,n,230,{font:"28px monospace",color:z.score}),x(t,`LAPS: ${s.lap-1}/${s.totalLaps}`,n,280,{font:"20px monospace",color:z.textDim}),s.bestScore!==null&&s.score>=s.bestScore&&x(t,"NEW RECORD!",n,330,{font:"bold 24px monospace",color:z.timer}),x(t,"PRESS SPACE TO CONTINUE",n,this.height-80,{font:"18px monospace",color:z.textDim})}}const rt=(e,t)=>{const s=new Map;return s.set("main-menu",new Ln(e,t)),s.set("music-select",new wn(e,t)),s.set("recs",new In(e,t)),s.set("results",new kn(e,t)),s},v={background:"rgba(0, 0, 0, 0.75)",backgroundLight:"rgba(0, 0, 0, 0.6)",timer:"#ffcc00",timerLow:"#ff4444",score:"#00ff88",lap:"#00ccff",speed:"#ffffff",barBg:"#333333",barGreen:"#22c55e",barRed:"#ef4444",barYellow:"#eab308",position:"#ffffff",boost:"#06b6d4",mirrorBg:"#1a3d1a",mirrorRoad:"#444444",mirrorLine:"#666666"},at={speed:0,maxSpeed:300,position:1,totalPositions:4,boostMeter:1,mirrorCars:[]},xt=e=>e===1?"ST":e===2?"ND":e===3?"RD":"TH",X=(e,t,s,n,o,i,r="left")=>{e.font=`bold ${o}px "Courier New", monospace`,e.fillStyle=i,e.textAlign=r,e.textBaseline="top",e.fillStyle="rgba(0, 0, 0, 0.5)";const a=r==="right"?-2:2;e.fillText(t,s+a,n+2),e.fillStyle=i,e.fillText(t,s,n)},Jt=(e,t,s,n,o,i)=>{e.fillStyle=v.backgroundLight,e.fillRect(t-2,s-2,n+4,o+4),e.strokeStyle="#888888",e.lineWidth=2,e.strokeRect(t-2,s-2,n+4,o+4),e.fillStyle=v.mirrorBg,e.fillRect(t,s,n,o);const r=t+n/2,a=s+8,c=s+o-16,l=n*.85;e.fillStyle=v.mirrorRoad,e.beginPath(),e.moveTo(r-l*.3,a),e.lineTo(r+l*.3,a),e.lineTo(r+l*.5,c),e.lineTo(r-l*.5,c),e.closePath(),e.fill(),e.strokeStyle=v.mirrorLine,e.lineWidth=1,e.setLineDash([4,4]),e.beginPath(),e.moveTo(r,a),e.lineTo(r,c),e.stroke(),e.setLineDash([]);const d=[...i].sort((h,p)=>p.distance-h.distance);for(const h of d){const p=.4+(1-h.distance)*.6,g=r+h.offset*l*.4*p,u=a+(c-a)*(1-h.distance*.8),R=16*p,E=10*p;e.fillStyle="rgba(0, 0, 0, 0.3)",e.fillRect(g-R/2+1,u-E/2+1,R,E),e.fillStyle=h.color,e.fillRect(g-R/2,u-E/2,R,E),e.fillStyle="rgba(255, 255, 255, 0.3)",e.fillRect(g-R/2,u-E/2,R,E*.3)}e.font='10px "Courier New", monospace',e.fillStyle="#666666",e.textAlign="center",e.textBaseline="bottom",e.fillText("◀ REAR VIEW ▶",t+n/2,s+o-2)},An=(e,t,s,n,o)=>{e.fillStyle=v.background,e.fillRect(t,s,180,80),e.strokeStyle="#555",e.lineWidth=1,e.strokeRect(t,s,180,80);const a=Math.round(n),c=n/o;X(e,`${a.toString().padStart(3,"0")} KMH`,t+15,s+10,24,v.speed);const l=t+15,d=s+45,h=150,p=14;e.fillStyle=v.barBg,e.fillRect(l,d,h,p);const g=c>.8?v.barRed:c>.5?v.barYellow:v.barGreen,u=Math.max(0,Math.min(1,c))*h;e.fillStyle=g,e.fillRect(l,d,u,p),e.strokeStyle="#666",e.lineWidth=1,e.strokeRect(l,d,h,p);for(let R=1;R<4;R++){const E=l+h/4*R;e.beginPath(),e.moveTo(E,d),e.lineTo(E,d+p),e.strokeStyle="rgba(255, 255, 255, 0.2)",e.stroke()}},Cn=(e,t,s,n,o)=>{e.fillStyle=v.background,e.fillRect(t,s,120,80),e.strokeStyle="#555",e.lineWidth=1,e.strokeRect(t,s,120,80);const a=`${n}${xt(n)}`,c=n===1?v.barYellow:v.position;e.font='bold 48px "Courier New", monospace',e.fillStyle="rgba(0, 0, 0, 0.5)",e.textAlign="center",e.textBaseline="top",e.fillText(a,t+120/2+2,s+8),e.fillStyle=c,e.fillText(a,t+120/2,s+6),e.font='14px "Courier New", monospace',e.fillStyle="#888888",e.fillText(`OF ${o}`,t+120/2,s+58)},Dn=(e,t,s,n)=>{e.fillStyle=v.background,e.fillRect(s,n,160,70),e.strokeStyle="#555",e.lineWidth=1,e.strokeRect(s,n,160,70);const r=t.gameMode==="race",a=!r&&t.currentTime<10?v.timerLow:v.timer;X(e,r?"RACE TIME":"TIME",s+15,n+8,14,"#888888"),X(e,Kt(t.currentTime),s+15,n+28,28,a)},On=(e,t,s,n)=>{e.fillStyle=v.background,e.fillRect(s,n,180,45),e.strokeStyle="#555",e.lineWidth=1,e.strokeRect(s,n,180,45),X(e,"SCORE",s+15,n+8,14,"#888888"),X(e,rn(t),s+15,n+24,18,v.score)},Pn=(e,t,s,n,o)=>{e.fillStyle=v.background,e.fillRect(n,o,120,45),e.strokeStyle="#555",e.lineWidth=1,e.strokeRect(n,o,120,45),X(e,"LAP",n+15,o+8,14,"#888888"),X(e,`${t}/${s}`,n+15,o+24,18,v.lap)},Bn=(e,t,s,n)=>{e.fillStyle=v.background,e.fillRect(s,n,100,45),e.strokeStyle="#555",e.lineWidth=1,e.strokeRect(s,n,100,45),X(e,"NITRO",s+10,n+8,12,"#888888");const r=s+10,a=n+26,c=80,l=10;e.fillStyle=v.barBg,e.fillRect(r,a,c,l);const d=t<.3?v.barRed:v.boost,h=Math.max(0,Math.min(1,t))*c;e.fillStyle=d,e.fillRect(r,a,h,l),e.strokeStyle="#666",e.lineWidth=1,e.strokeRect(r,a,c,l)},Nn=(e,t,s,n,o={})=>{const{width:i}=n,r={...at,...o,speed:s},a=15,c=220,l=100,d=i/2-c/2,h=a;Jt(e,d,h,c,l,r.mirrorCars);const p=a,g=i-a,u=h+l+15,R=u+90,E=R+55;An(e,p,u,r.speed,r.maxSpeed),Cn(e,p,R,r.position,r.totalPositions),Dn(e,t,g-160,u),On(e,t.score,g-180,R),Pn(e,t.lap,t.totalLaps,g-120,E),Bn(e,r.boostMeter,g-230,E)},Hn=(e,t,s)=>{e.fillStyle="rgba(0, 0, 0, 0.7)",e.fillRect(0,0,t,s),e.font='bold 48px "Courier New", monospace',e.fillStyle="#ffffff",e.textAlign="center",e.textBaseline="middle",e.fillText("PAUSED",t/2,s/2-40),e.font='24px "Courier New", monospace',e.fillStyle="#888888",e.fillText("Press P to resume",t/2,s/2+20),e.fillStyle="#666666",e.fillText("Press F for fullscreen",t/2,s/2+55)},_n=(e,t,s,n)=>{const o=n>0?n.toString():"GO!",i=n>0?"#ffcc00":"#00ff88";e.font='bold 96px "Courier New", monospace',e.fillStyle=i,e.textAlign="center",e.textBaseline="middle",e.fillStyle="rgba(0, 0, 0, 0.4)",e.fillText(o,t/2+4,s/2+4),e.fillStyle=i,e.fillText(o,t/2,s/2)},Gn=(e,t,s,n,o={})=>{const{width:i,height:r,x:a,y:c}=n,l={...at,...o,speed:s};e.save(),e.translate(a,c);const d=i/1024,h=r/768,p=Math.min(d,h),g=Math.max(8,15*p),u=Math.max(110,220*p),R=Math.max(50,100*p),E=i/2-u/2,w=g;Jt(e,E,w,u,R,l.mirrorCars);const N=g,_=i-g,A=w+R+g,F=A+90*p,Z=Math.max(100,180*p),pe=Math.max(45,80*p);Un(e,N,A,Z,pe,l.speed,l.maxSpeed),Fn(e,N,F,Math.max(70,120*p),Math.max(45,80*p),l.position,l.totalPositions),Wn(e,t,_-Math.max(80,160*p),A,Math.max(80,160*p),Math.max(40,70*p)),Yn(e,t.lap,t.totalLaps,_-Math.max(60,120*p),F,Math.max(60,120*p),Math.max(30,45*p)),e.restore()},Un=(e,t,s,n,o,i,r)=>{e.fillStyle=v.background,e.fillRect(t,s,n,o),e.strokeStyle="#555",e.lineWidth=1,e.strokeRect(t,s,n,o);const a=Math.round(i),c=i/r,l=Math.max(14,o*.35);X(e,`${a.toString().padStart(3,"0")}`,t+n*.5,s+o*.25,l,v.speed,"center");const d=t+n*.1,h=s+o*.6,p=n*.8,g=o*.2;e.fillStyle=v.barBg,e.fillRect(d,h,p,g);const u=c>.8?v.barRed:c>.5?v.barYellow:v.barGreen,R=Math.max(0,Math.min(1,c))*p;e.fillStyle=u,e.fillRect(d,h,R,g),e.strokeStyle="#666",e.strokeRect(d,h,p,g)},Fn=(e,t,s,n,o,i,r)=>{e.fillStyle=v.background,e.fillRect(t,s,n,o),e.strokeStyle="#555",e.lineWidth=1,e.strokeRect(t,s,n,o);const a=`${i}${xt(i)}`,c=i===1?v.barYellow:v.position,l=Math.max(18,o*.5);e.font=`bold ${l}px "Courier New", monospace`,e.fillStyle="rgba(0, 0, 0, 0.5)",e.textAlign="center",e.textBaseline="top",e.fillText(a,t+n/2+2,s+8),e.fillStyle=c,e.fillText(a,t+n/2,s+6);const d=Math.max(10,o*.2);e.font=`${d}px "Courier New", monospace`,e.fillStyle="#888888",e.fillText(`OF ${r}`,t+n/2,s+o-d-5)},Wn=(e,t,s,n,o,i)=>{e.fillStyle=v.background,e.fillRect(s,n,o,i),e.strokeStyle="#555",e.lineWidth=1,e.strokeRect(s,n,o,i);const r=t.gameMode==="race",a=!r&&t.currentTime<10?v.timerLow:v.timer,c=Math.max(12,i*.45);X(e,r?"RACE TIME":"TIME",s+o*.1,n+i*.1,c*.5,"#888888"),X(e,Kt(t.currentTime),s+o*.1,n+i*.4,c,a)},Yn=(e,t,s,n,o,i,r)=>{e.fillStyle=v.background,e.fillRect(n,o,i,r),e.strokeStyle="#555",e.lineWidth=1,e.strokeRect(n,o,i,r);const a=Math.max(12,r*.5);X(e,"LAP",n+i*.1,o+r*.1,a*.5,"#888888"),X(e,`${t}/${s}`,n+i*.1,o+r*.4,a,v.lap)},Qt=()=>({...at}),B=document.getElementById("canvas");if(!B)throw new Error("Canvas element not found");const M=B.getContext("2d");if(!M)throw new Error("Could not get 2d context");const Ct=1024,Dt=768;let f=Gt();const xe=1/f.config.fps;let ke=null,es=null,ts=null,ss=null,Ot=Bt(),Je=0,y=$t(f.trackLength,f.config.segmentLength),ae=rt(f.config.width,f.config.height),Ge=Qt(),H=1,ct=new qt(H),Te=fn(H);const re=1/Math.tan(100/2*Math.PI/180),Xe=1e3,he=f.player.z;let ge=f.config.height/480,ue=0,Ue=0,Ae=!1;const ze=20;let ns="night";const lt=()=>gt[ns]??gt.night,Ke=(e,t)=>{const s=window.innerWidth,n=window.innerHeight,o=Math.min(s/Ct,n/Dt),i=Math.floor(Ct*o),r=Math.floor(Dt*o);B.width=i,B.height=r,B.style.width=`${i}px`,B.style.height=`${r}px`,f.config.width=i,f.config.height=r,ge=r/480,ae=rt(f.config.width,f.config.height)},Xn=async()=>{try{if(document.fullscreenElement)await document.exitFullscreen(),Ae=!1,Ke();else{await document.documentElement.requestFullscreen(),Ae=!0;const e=window.screen.width,t=window.screen.height;B.width=e,B.height=t,B.style.width=`${e}px`,B.style.height=`${t}px`,f.config.width=e,f.config.height=t,ge=t/480,ae=rt(f.config.width,f.config.height)}}catch(e){console.warn("Fullscreen not available:",e)}};document.addEventListener("fullscreenchange",()=>{!document.fullscreenElement&&Ae&&(Ae=!1,Ke())});const zn=async()=>{await Us(),ke=K.get("background-level-1.svg",1),es=K.get("player-car.svg",.5),ts=K.get("player-car-right.svg",.5),ss=K.get("player-car-left.svg",.5)},Vn=new Map([["215_540_5","PALM_TREE"],["385_265_230","BILLBOARD08"],["360_360_625","TREE1"],["135_332_5","DEAD_TREE1"],["328_282_150","BILLBOARD09"],["320_220_230","BOULDER3"],["200_315_995","COLUMN"],["300_170_625","BILLBOARD01"],["298_190_488","BILLBOARD06"],["298_190_5","BILLBOARD05"],["298_190_313","BILLBOARD07"],["298_140_621","BOULDER2"],["282_295_1205","TREE2"],["268_170_1205","BILLBOARD04"],["150_260_1205","DEAD_TREE2"],["168_248_1205","BOULDER1"],["240_155_5","BUSH1"],["235_118_929","CACTUS"],["232_152_255","BUSH2"],["230_220_5","BILLBOARD03"],["215_220_245","BILLBOARD02"],["195_140_995","STUMP"],["122_144_1365","SEMI"],["100_78_1365","TRUCK"],["88_55_1383","CAR03"],["80_59_1383","CAR02"],["80_57_1383","CAR04"],["80_56_1205","CAR01"]]),Ve=(e,t)=>{const s=`${e.w}_${e.h}_${e.x}`,n=Vn.get(s)??null;return n&&t&&t[n]?t[n]:n},st=e=>e<-.5?ts:e>.5?ss:es,be=(e,t)=>{const s=parseInt(e.replace("#",""),16),n=Math.min(255,Math.max(0,(s>>16)+t)),o=Math.min(255,Math.max(0,(s>>8&255)+t)),i=Math.min(255,Math.max(0,(s&255)+t));return`#${((1<<24)+(n<<16)+(o<<8)+i).toString(16).slice(1)}`},$n=()=>{const{config:e,player:t,skyOffset:s,currentTheme:n}=f,{width:o,height:i,lanes:r,roadWidth:a,segmentLength:c,drawDistance:l,fogDensity:d}=e;M.clearRect(0,0,B.width,B.height);const h=n??lt(),p=h.colors.fog,g=h.colors.sky;M.fillStyle=g,M.fillRect(0,0,o,i/2);const u=se(t.position,c),R=Re(t.position,c),E=se(t.position+he,c),w=Re(t.position+he,c),N=Y(E.p1.world.y,E.p2.world.y,w);let _=i,A=0,F=-(u.curve*R);ke&&(M.save(),h.filters.background&&(M.filter=h.filters.background),Yt(M,ke,o,i,s,ge*.001*N),M.restore());const Z={light:h.colors.road,dark:{...h.colors.road,road:be(h.colors.road.road,-15),grass:be(h.colors.road.grass,-15),rumble:be(h.colors.road.rumble,-15)}};for(let U=0;U<l;U++){const j=(u.index+U)%f.segments.length,m=f.segments[j];if(!m||(m.looped=m.index<u.index,m.fog=Nt(U/l,h.effects.fogDensity),m.clip=_,Fe(m.p1,t.x*a-A,N+Xe-(f.jumpState.peakHeight||0)*50,t.position-(m.looped?f.trackLength:0),re,o,i,a),Fe(m.p2,t.x*a-A-F,N+Xe-(f.jumpState.peakHeight||0)*50,t.position-(m.looped?f.trackLength:0),re,o,i,a),A+=F,F+=m.curve,m.p1.camera.z<=re||m.p2.screen.y>=m.p1.screen.y||m.p2.screen.y>=_))continue;const I=Math.floor(m.index/e.rumbleLength)%2?Z.light:Z.dark;Ft(M,o,r,m.p1.screen.x,m.p1.screen.y,m.p1.screen.w??0,m.p2.screen.x,m.p2.screen.y,m.p2.screen.w??0,m.fog??0,I),Wt(M,0,m.p2.screen.y,o,m.p1.screen.y-m.p2.screen.y,m.fog??0,p),_=m.p1.screen.y}for(let U=l-1;U>0;U--){const j=(u.index+U)%f.segments.length,m=f.segments[j];if(m){for(const I of m.cars){const T=Y(m.p1.screen.scale,m.p2.screen.scale,I.percent??0),L=Y(m.p1.screen.x,m.p2.screen.x,I.percent??0)+T*I.offset*a*o/2,C=Y(m.p1.screen.y,m.p2.screen.y,I.percent??0),G=Ve(I.sprite,f.currentTheme?.spriteOverrides);if(G){const W=Ye(G,T);W&&We(M,W,o,a,T,L,C,-.5,-1,m.clip??0,I.sprite.w,I.sprite.h)}}for(const I of m.sprites){const T=m.p1.screen.scale,L=m.p1.screen.x+T*I.offset*a*o/2,C=m.p1.screen.y,G=Ve(I.source,f.currentTheme?.spriteOverrides);if(G){const W=Ye(G,T);W&&We(M,W,o,a,T,L,C,I.offset<0?-1:0,-1,m.clip??0,I.source.w,I.source.h)}}if(m===E){const I=re/he,T=i/2-I*Y(E.p1.camera.y,E.p2.camera.y,w)*i/2,L=t.speed/e.maxSpeed,C=1.5*Math.random()*L*ge*(Math.random()>.5?1:-1),G=t.speed*(f.input.left?-1:f.input.right?1:0),W=st(G);W&&et(M,W,o,i,a,L,I,o/2,T,G,C)}}}const pe=f.trackLength*.08,Ce=Ut(f.cars,t.position,f.trackLength,pe,3),De=t.speed/e.maxSpeed*300;let Oe=1;for(const U of f.cars)U.z>t.position&&Oe++;Os(M,f.particles,new Map);for(const U of f.tumbleweeds){const j=U.z-t.position;if(j>0&&j<8e3){const m=1-j/8e3,I=.5+m*.8,T=i*.75+m*100,L=o/2+U.x*o*.25,C=K.get("tumbleweed.svg",I);C&&Ps(M,{x:L,y:T,rotation:U.rotation,scale:I},C)}}f.lightningActive&&h.effects.lightning&&Ds(M,o,i,h.effects.lightning.flashIntensity),Ge={...Ge,speed:De,maxSpeed:300,position:Math.min(Oe,ze+1),totalPositions:ze+1,mirrorCars:Ce.slice(0,3),boostMeter:Math.min(1,y.currentTime/it)},Nn(M,y,De,{width:o},Ge),ue>0&&_n(M,o,i,ue),y.isPaused&&Hn(M,o,i)},Kn=()=>{const{width:e,height:t}=f.config,s=e/2,n=t;M.clearRect(0,0,B.width,B.height),Bs(M,e/2,0,t);for(let o=0;o<H;o++){const i=f.players[o];if(!i)continue;const r=o===0?0:e/2;M.save(),M.beginPath(),M.rect(r,0,s,n),M.clip();const a=f.player;f.player=i,Zn(r,s,n,o),f.player=a,M.restore()}},Zn=(e,t,s,n)=>{const{config:o,player:i,skyOffset:r,currentTheme:a}=f,{lanes:c,roadWidth:l,segmentLength:d,drawDistance:h,fogDensity:p}=o,g=a??lt();g.colors.fog;const u=g.colors.sky;M.save(),M.translate(e,0),M.fillStyle=u,M.fillRect(0,0,t,s/2);const R=se(i.position,d),E=Re(i.position,d),w=se(i.position+he,d),N=Re(i.position+he,d),_=Y(w.p1.world.y,w.p2.world.y,N);let A=s,F=0,Z=-(R.curve*E);ke&&(M.save(),g.filters.background&&(M.filter=g.filters.background),Yt(M,ke,t,s,r,ge*.001*_),M.restore());const pe={light:g.colors.road,dark:{...g.colors.road,road:be(g.colors.road.road,-15),grass:be(g.colors.road.grass,-15),rumble:be(g.colors.road.rumble,-15)}};for(let m=0;m<h;m++){const I=(R.index+m)%f.segments.length,T=f.segments[I];if(!T||(T.looped=T.index<R.index,T.fog=Nt(m/h,g.effects.fogDensity),T.clip=A,Fe(T.p1,i.x*l-F,_+Xe-(f.jumpState.peakHeight||0)*50,i.position-(T.looped?f.trackLength:0),re,t,s,l),Fe(T.p2,i.x*l-F-Z,_+Xe-(f.jumpState.peakHeight||0)*50,i.position-(T.looped?f.trackLength:0),re,t,s,l),F+=Z,Z+=T.curve,T.p1.camera.z<=re||T.p2.screen.y>=T.p1.screen.y||T.p2.screen.y>=A))continue;const L=Math.floor(T.index/o.rumbleLength)%2?pe.light:pe.dark;Ft(M,t,c,T.p1.screen.x,T.p1.screen.y,T.p1.screen.w??0,T.p2.screen.x,T.p2.screen.y,T.p2.screen.w??0,T.fog??0,L),A=T.p1.screen.y}for(let m=h-1;m>0;m--){const I=(R.index+m)%f.segments.length,T=f.segments[I];if(T){for(const L of T.cars){const C=Y(T.p1.screen.scale,T.p2.screen.scale,L.percent??0),G=Y(T.p1.screen.x,T.p2.screen.x,L.percent??0)+C*L.offset*l*t/2,W=Y(T.p1.screen.y,T.p2.screen.y,L.percent??0),q=Ve(L.sprite,f.currentTheme?.spriteOverrides);if(q){const V=Ye(q,C);V&&We(M,V,t,l,C,G,W,-.5,-1,T.clip??0,L.sprite.w,L.sprite.h)}}for(const L of T.sprites){const C=T.p1.screen.scale,G=T.p1.screen.x+C*L.offset*l*t/2,W=T.p1.screen.y,q=Ve(L.source,f.currentTheme?.spriteOverrides);if(q){const V=Ye(q,C);V&&We(M,V,t,l,C,G,W,L.offset<0?-1:0,-1,T.clip??0,L.source.w,L.source.h)}}if(T===w){const L=re/he,C=s/2-L*Y(w.p1.camera.y,w.p2.camera.y,N)*s/2,G=i.speed/o.maxSpeed,W=1.5*Math.random()*G*ge*(Math.random()>.5?1:-1),q=f.inputs[n]??f.input,V=i.speed*(q.left?-1:q.right?1:0),me=st(V);me&&et(M,me,t,s,l,G,L,t/2,C,V,W)}if(H>1)for(let L=0;L<H;L++){if(L===n)continue;const C=f.players[L],G=f.inputs[L];if(!C||!G)continue;const W=C.position+he,q=Math.floor(W/d)%f.segments.length;if(T.index===q){const V=Re(W,d),me=Y(T.p1.screen.scale,T.p2.screen.scale,V),cs=s/2-me*Y(T.p1.camera.y,T.p2.camera.y,V)*s/2,ft=C.speed/o.maxSpeed,ls=1.5*Math.random()*ft*ge*(Math.random()>.5?1:-1),dt=C.speed*(G.left?-1:G.right?1:0),ht=st(dt);if(ht){const fs=(C.x-i.x)*l*t*me*.5;et(M,ht,t,s,l,ft,me,t/2+fs,cs,dt,ls)}}}}}const Ce=i.speed/o.maxSpeed*300,De=f.trackLength*.08,Oe=Ut(f.cars,i.position,f.trackLength,De,3);let U=1;for(const m of f.cars)m.z>i.position&&U++;for(let m=0;m<H;m++){if(m===n)continue;const I=f.players[m];I&&I.position>i.position&&U++}const j=ze+H;Gn(M,y,Ce,{width:t,height:s,x:0,y:0},{speed:Ce,maxSpeed:300,position:Math.min(U,j),totalPositions:j,mirrorCars:Oe.slice(0,3),boostMeter:Math.min(1,y.currentTime/it)}),M.restore()},jn=()=>{const{width:e,height:t}=f.config;if(y.screen==="racing")H===1?$n():Kn();else{const s=ae.get(y.screen);s&&(M.fillStyle="#1a1a2e",M.fillRect(0,0,B.width,B.height),s.render(M,y))}},qn=e=>{if(!(y.screen!=="racing"||y.isPaused||ue>0))if(y=Js(y,e),H===1){const t=f.currentLapTime;vt(f,e);const s=f.player.speed/f.config.maxSpeed;St(f,e,s),Tt(f),yt(f,e),Rt(f,e),bt(f,e),Et(f,e),It(s);const n=Qs(y,f.player.position,f.trackLength,f.config.segmentLength);n.bonusAwarded>0&&(y=n.state),t>0&&f.currentLapTime===0&&f.lastLapTime!==null&&(y=en(y,f))}else{for(let t=0;t<H;t++){const s=f.players[t],n=f.inputs[t];if(!s||!n)continue;f.player=s,f.input=n;const o=f.currentLapTime;vt(f,e);const i=s.speed/f.config.maxSpeed;St(f,e,i),Tt(f),yt(f,e),Rt(f,e),bt(f,e),Et(f,e),t===0&&It(i),o>0&&f.currentLapTime===0&&f.lastLapTime!==null&&(Te=hn(Te,t,f))}Rn(f.players,f.config.segmentLength,Vt),f.player=f.players[0],f.input=f.inputs[0],Te=dn(Te,e)}},os=()=>{const e=Bt(),t=Math.min(1,(e-Ot)/1e3);for(Je+=t,ue>0&&(Ue+=t,Ue>=1&&(ue--,Ue=0));Je>xe;)Je-=xe,qn(xe);jn(),Ot=e,requestAnimationFrame(os)},is=async()=>{y={...y,screen:"music-select"};const t=ae.get("music-select")?.getSelectedTrack();t&&t.file?(await Ie(t.file),ve(.3)):Me()},$e=async e=>{f=Gt(H),f.onCollision=Vt;const t=ae.get("music-select");ns=e??"night";const s=lt();vs(f,s),B.style.filter=s.filters.global,ws(f,ze),H>1&&(f.players[0]&&(f.players[0].x=-.5),f.players[1]&&(f.players[1].x=.5),ct=new qt(H),Te=gn(Te,H)),y=tn(y),ue=3,Ue=0,Ge=Qt();const n=t?.getSelectedTrack();n&&n.file?(Me(),await Ie(n.file),ve(.3)):Me(),zs()},rs=()=>{y={...y,screen:"recs"}},xn=async e=>{const t=ae.get(y.screen);if(y.screen==="main-menu"){const s=t;s&&(H=s.getPlayerCount());const n=t?.handleKeyDown?.(e);if(s){H=s.getPlayerCount();const o=s.getGameMode();y.gameMode!==o&&(y=Zt(y))}if(n==="start")await is();else if(n==="constructor")rs();else if(n==="sound"){const o=Xt();console.log(`Sound ${o?"enabled":"disabled"}`)}}else if(y.screen==="recs"){const s=t,n=t?.handleKeyDown?.(e);if(n==="start_game"){const o=s?.getSelectedThemeId()??"night";await $e(o)}else n==="back"&&(y={...y,screen:"main-menu"})}else if(y.screen==="music-select"){const s=t,n=s?.getSelectedTrack(),o=t?.handleKeyDown?.(e),i=s?.getSelectedTrack();o==="start_game"?$e():n?.id!==i?.id&&i&&(i.file?(await Ie(i.file),ve(.3)):Me())}else if(y.screen==="results"){if(e===k.SPACE){y=on(y),ot();const s=oe[0];s&&s.file&&(await Ie(s.file),ve(.3))}}else y.screen==="racing"&&((e===k.P||e===27)&&(y.isPaused?y=nn(y):y=sn(y)),(e===k.F||e===122)&&Xn())};document.addEventListener("keydown",e=>{e.keyCode===122&&e.preventDefault(),y.screen==="racing"&&!y.isPaused&&ue===0&&(H===1?As(f,e.keyCode):ct.handleKeyDown(f.inputs,e.keyCode)),xn(e.keyCode)});document.addEventListener("keyup",e=>{y.screen==="racing"&&(H===1?Cs(f,e.keyCode):ct.handleKeyUp(f.inputs,e.keyCode))});B.addEventListener("click",async e=>{const t=B.getBoundingClientRect(),s=(e.clientX-t.left)*(f.config.width/t.width),n=(e.clientY-t.top)*(f.config.height/t.height),o=ae.get(y.screen);if(y.screen==="main-menu"){const i=o;i&&(H=i.getPlayerCount());const r=o?.handleClick?.(s,n);if(i){H=i.getPlayerCount();const a=i.getGameMode();y.gameMode!==a&&(y=Zt(y))}if(r==="start")await is();else if(r==="constructor")rs();else if(r==="sound"){const a=Xt();console.log(`Sound ${a?"enabled":"disabled"}`)}}else if(y.screen==="music-select")o?.handleClick?.(s,n)==="start_game"&&await $e();else if(y.screen==="recs"){const i=o,r=o?.handleClick?.(s,n);if(r==="start_game"){const a=i?.getSelectedThemeId()??"night";await $e(a)}else r==="back"&&(y={...y,screen:"main-menu"})}});B.addEventListener("mousemove",e=>{const t=B.getBoundingClientRect(),s=(e.clientX-t.left)*(f.config.width/t.width),n=(e.clientY-t.top)*(f.config.height/t.height),o=ae.get(y.screen);if(o?.handleMouseMove?.(s,n),y.screen==="main-menu"||y.screen==="music-select"||y.screen==="recs"){const i=o?.getZones?.()??[];for(const r of i)if(s>=r.x&&s<=r.x+r.width&&n>=r.y&&n<=r.y+r.height){B.style.cursor="pointer";return}}B.style.cursor="default"});Ke();window.addEventListener("resize",()=>{Ae||Ke()});const Jn=async()=>{try{await zn(),console.log("SVG sprites loaded successfully")}catch(e){console.error("Failed to load SVG sprites:",e)}ve(.3),os()};let Pt=!1;const as=async()=>{if(Pt)return;Pt=!0;const e=oe[0];e&&(await Ie(e.file),ve(.3))};document.addEventListener("click",as,{once:!0});document.addEventListener("keydown",as,{once:!0});Jn();
//# sourceMappingURL=main-BYDAHYrg.js.map
